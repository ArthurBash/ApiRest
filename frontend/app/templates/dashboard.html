{% extends 'base.html' %}

{% block title %}Galería de Fotos{% endblock %}

{% block extra_css %}
<style>
  .filters {
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  #photo-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .photo-item {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .photo-item:hover {
    transform: scale(1.05);
  }
  
  #loading {
    text-align: center;
    padding: 20px;
    display: none;
  }
  
  #fullscreen {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.9);
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  
  #fullscreen img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 8px;
  }
  
  .no-photos {
    text-align: center;
    padding: 40px;
    color: #666;
  }
  
  .close-fullscreen {
    position: absolute;
    top: 20px;
    right: 30px;
    color: white;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    z-index: 1001;
  }
  
  .close-fullscreen:hover {
    opacity: 0.7;
  }

  #photo-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
  .photo-item { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; cursor: pointer; transition: transform 0.3s ease; }
  .photo-item:hover { transform: scale(1.05); }
  #loading { text-align: center; padding: 20px; display: none; }
  #fullscreen { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; z-index: 1000; }
  #fullscreen img { max-width: 90%; max-height: 90%; }
  .close-fullscreen { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }
</style>
{% endblock %}

{% block page_title %}
<h1 class="title">Galería de Fotos</h1>
{% endblock %}

{% block content %}
{% if session.get('access_token') %}
  <div class="box">
    <div class="field">
      <label class="label" for="folder-select">
        <span class="icon-text">
          <span class="icon"><i class="fas fa-folder"></i></span>
          <span>Filtrar por carpeta:</span>
        </span>
      </label>
      <div class="control">
        <div class="select is-fullwidth">
          <select id="folder-select">
            <option value="">Todas las fotos</option>
            </select>
        </div>
      </div>
    </div>
  </div>
  
  <div id="photo-container"></div>
  <div id="loading"><button class="button is-loading is-large">Cargando</button></div>
  <div id="no-photos" style="display: none;"><p>No hay fotos en esta carpeta.</p></div>
  <div id="fullscreen" onclick="closeFullscreen()">
    <span class="close-fullscreen">&times;</span>
    <img id="fullscreen-img" />
  </div>
{% else %}
  <p>Debes iniciar sesión para ver la galería.</p>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if session.get('access_token') %}
<script>
  const ACCESS_TOKEN = "{{ access_token }}";

  class PhotoGallery {
    constructor() {
      this.currentPage = 1;
      this.pageSize = 20;
      this.hasNext = true;
      this.loading = false;
      this.folderId = '';
      this.controller = new AbortController(); // Añadimos un AbortController para cancelar peticiones.
      
      this.photoContainer = document.getElementById('photo-container');
      this.loadingIndicator = document.getElementById('loading');
      this.folderSelect = document.getElementById('folder-select');
      
      this.init();
    }
    
    async loadFolders() {
      try {
        const response = await fetch('/api/folders', {
          headers: { 'Authorization': `Bearer ${ACCESS_TOKEN}` }
        });
        if (!response.ok) throw new Error('Error al cargar carpetas');
        
        const folders = await response.json();
        
        folders.forEach(folder => {
          const option = document.createElement('option');
          option.value = folder.id;
          option.textContent = folder.name;
          this.folderSelect.appendChild(option);
        });

      } catch (error) {
        console.error('Error fetching folders:', error);
      }
    }
    
    async loadPhotos(reset = false) {
      if (this.loading || (!this.hasNext && !reset)) return;
      
      // ✅ Clave 1: Si hay una carga en curso, la cancelamos antes de empezar una nueva.
      if (this.loading) {
        this.controller.abort();
        this.controller = new AbortController();
      }
      
      if (reset) {
        this.photoContainer.innerHTML = '';
        this.currentPage = 1;
        this.hasNext = true;
      }
      
      this.loading = true;
      this.loadingIndicator.style.display = 'block';
      
      const params = new URLSearchParams({ page: this.currentPage, page_size: this.pageSize });
      if (this.folderId) {
        params.append('folder_id', this.folderId);
      }
      
      try {
        const response = await fetch(`/api/photoss?${params}`, {
          headers: { 'Authorization': `Bearer ${ACCESS_TOKEN}` },
          signal: this.controller.signal // ✅ Clave 2: Le pasamos la señal de aborto a la petición.
        });
        
        const data = await response.json();
        
        if (response.ok) {
          this.displayPhotos(data.photos); 
          this.hasNext = data.has_next;
          this.currentPage++;
        } else {
          console.error('Error al cargar fotos:', data.error);
        }
        
      } catch (error) {
          if (error.name === 'AbortError') {
              console.log('La petición fue cancelada. Esto es normal.');
          } else {
              console.error('Error de red:', error);
          }
      } finally {
        this.loading = false;
        this.loadingIndicator.style.display = 'none';
      }
    }
    
    displayPhotos(photos) {
      const noPhotosMessage = document.getElementById('no-photos');
      if (photos.length === 0 && this.currentPage === 1) {
        noPhotosMessage.style.display = 'block';
      } else {
        noPhotosMessage.style.display = 'none';
      }

      photos.forEach(photo => {
        const imgElement = document.createElement('img');
        imgElement.src = `/photo_proxy?file=${encodeURIComponent(photo.signed_url)}`;
        imgElement.alt = photo.name;
        imgElement.classList.add('photo-item');
        imgElement.onclick = () => {
          document.getElementById('fullscreen-img').src = `/photo_proxy?file=${encodeURIComponent(photo.signed_url)}`;
          document.getElementById('fullscreen').style.display = 'flex';
        };
        this.photoContainer.appendChild(imgElement);
      });
    }
    
    setupFolderFilter() {
      this.folderSelect.addEventListener('change', (e) => {
        this.folderId = e.target.value;
        this.loadPhotos(true);
      });
    }
    
    setupInfiniteScroll() {
      window.addEventListener('scroll', () => {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
          this.loadPhotos();
        }
      });
    }
    
    async init() {
      await this.loadFolders();
      this.setupFolderFilter();
      this.setupInfiniteScroll();
      this.loadPhotos();
    }
  }
  
  function closeFullscreen() {
    document.getElementById('fullscreen').style.display = 'none';
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    new PhotoGallery();
  });
</script>
{% endif %}
{% endblock %}